<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>game</title>
	<script src="./js/option.js"></script>
	<script src="./js/engineFilesV3_7_16.js"></script>
	<script>
	window.engineFiles = engineFilesV3_7_16;
	window.g = engineFiles.akashicEngine;
	(function() {
		var originalRequire = window.require;
		window.require = function(moduleName) {
			switch(moduleName) {
				case "@akashic/akashic-engine":
					return engineFiles.akashicEngine;
				default:
					return this.call(this, moduleName);
			}
		};
	})();
	</script>
	<script src="./js/initGlobals.js"></script>
	<script src="./js/pdi/LocalScriptAssetV3.js"></script>
	<script src="./js/pdi/LocalTextAssetV3.js"></script>
	<link rel="stylesheet" type="text/css" href="css/style.css">
	<script src="./js/game.json.js"></script>
	<script src="./js/assets/script/bootstrap.js"></script>
	<script src="./js/assets/script/main.js"></script>
	<script src="./js/sandbox.js"></script>
	<script type="module">
		import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
		import { getDatabase, ref, set, push, serverTimestamp, onValue, get, query, orderByChild, limitToFirst, equalTo } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";
		const firebaseConfig = {
			apiKey: "AIzaSyCECDNAJeWrKzZZiY41F3URHYxvNpAU30M",
			authDomain: "game1-af52e.firebaseapp.com",
			projectId: "game1-af52e",
			storageBucket: "game1-af52e.firebasestorage.app",
			messagingSenderId: "994583300223",
			appId: "1:994583300223:web:2e53787307d2d0a8bf574a",
			measurementId: "G-P220W9JEWD"
		};
		const app = initializeApp(firebaseConfig);
		const database = getDatabase(app);
		const url = new URL(window.location.href);
		const domain = url.hostname;
		const path = url.pathname.split('/').filter(Boolean);
		let latestScore = 0;
		let previousScore = 0;
		function saveScoreToFirebase(name, password, score) {
			return new Promise((resolve, reject) => {
				const scoresRef = ref(database, 'scores');
				const queryRef = query(scoresRef, orderByChild('name'), equalTo(name));
				get(queryRef).then((snapshot) => {
					let userRef = null;
					snapshot.forEach((childSnapshot) => {
						const data = childSnapshot.val();
						if (data.password === password) {
							userRef = childSnapshot.ref;
							return true;
						}
					});
					if (userRef) {
						get(userRef).then((snapshot) => {
							const userData = snapshot.val();
							if (score > userData.score) {
								set(userRef, {
									name: name,
									password: password,
									score: score,
									timestamp: serverTimestamp()
								}).then(() => {
									console.log('Score updated successfully');
									latestScore = score;
									resolve();
								}).catch(reject);
							} else {
								console.log('New score is not higher than the existing score');
								resolve();
							}
						}).catch(reject);
					} else {
						const newScoreRef = push(scoresRef);
						set(newScoreRef, {
							name: name,
							password: password,
							score: score,
							timestamp: serverTimestamp()
						}).then(() => {
							console.log('Score saved successfully');
							latestScore = score;
							resolve();
						}).catch(reject);
					}
				}).catch(reject);
			});
		}
		window.addEventListener('scoreUpdate', function(event) {
		const score = event.detail;
		document.getElementById('scoreDisplay').innerText = 'スコア: ' + score;
		document.getElementById('overlay').style.display = 'flex';
		document.getElementById('namePasswordForm').style.display = 'block';
		document.getElementById('retryButton').style.display = 'block';
	});
	function submitScore() {
		const name = document.getElementById('nameInput').value.trim();
		const password = document.getElementById('passwordInput').value.trim();
		const score = parseInt(document.getElementById('scoreDisplay').innerText.replace('スコア: ', ''), 10);
		previousScore = latestScore;
		if (name === "") {
			alert("名前を入力してください。");
			return;
		}
		if (name.match(/^\s+$/)) {
			alert("名前には空白文字以外を入力してください。");
			return;
		}
		if (domain !== "niconanashi.github.io" || path[0] !== "game1") {
			alert("このドメインからは送信できません。");
			return;
		}
		saveScoreToFirebase(name, password, score)
		.then(() => {
			fetchTopScores(displayTopScores, name, score, password); // ランキングボードを更新
		})
		.catch(error => console.error("Error saving score:", error))
		.finally(() => {
			document.getElementById('namePasswordForm').style.display = 'none';
			document.getElementById('rankingBoard').style.display = 'block'; // ランキングボードを表示
		});
	}
	window.submitScore = submitScore;
	function fetchTopScores(callback, playerName, playerScore, playerPassword) {
		const scoresRef = ref(database, 'scores');
		const topScoresQuery = query(scoresRef, orderByChild('score'), limitToFirst(100));
		onValue(topScoresQuery, (snapshot) => {
			const scores = [];
			snapshot.forEach((childSnapshot) => {
				scores.push(childSnapshot.val());
			});
			callback(scores, playerName, playerScore, playerPassword);
		});
	}
	function displayTopScores(scores, playerName, playerScore, playerPassword) {
		const rankingContainer = document.getElementById('rankingContainer');
		rankingContainer.innerHTML = '';
		scores.sort((a, b) => b.score - a.score);
		let rank = 1;
		scores.forEach((scoreData, index) => {
		if (index > 0 && scores[index - 1].score > scoreData.score) {
			rank = index + 1;
		}
		const date = new Date(scoreData.timestamp);
		const formattedDate = date.toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
		const scoreElement = document.createElement('div');
		let newIndicator = "";
		if (scoreData.name === playerName && scoreData.password === playerPassword) {
			if (scoreData.score === playerScore && scoreData.score > previousScore) {
					 newIndicator = " <span style='color:red; font-weight:bold;'>New!</span>";
			}
			scoreElement.style.color = "red";
		}
		scoreElement.innerHTML = `
			<div>${rank} 位</div>
			<div>${scoreData.name}</div>
			<div>${scoreData.score}pt</div>
			<div>${formattedDate}${newIndicator}</div>
		`;
		rankingContainer.appendChild(scoreElement);
	});
	}
	document.addEventListener('DOMContentLoaded', () => {
		fetchTopScores(displayTopScores, null, null, null);
	});
	function retry() {
		location.reload();
	}
	window.retry = retry;
</script>
<style>
	#overlay {
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background-color: rgba(0, 0, 0, 0.5);
		display: none;
		align-items: center;
		justify-content: center;
	}
	#rankingContainer {
		display: table;
		width: 100%;
		border-collapse: collapse;
	}
	#rankingContainer div {
		display: table-row;
	}
	#rankingContainer div > div {
		display: table-cell;
		padding: 8px;
		border: 1px solid #ddd;
		text-align: left;
	}
	#rankingContainer div > div:nth-child(1) { width: 50px; } /* 順位 */
	#rankingContainer div > div:nth-child(2) { width: 150px; } /* 名前 */
	#rankingContainer div > div:nth-child(3) { width: 100px; } /* スコア */
	#rankingContainer div > div:nth-child(4) { width: 200px; } /* 日付 */
	#namePasswordForm, #rankingBoard {
		background-color: #fff;
		padding: 40px;
		border-radius: 8px;
		box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
		text-align: center;
		font-size: 20px;
	}
	#namePasswordForm input[type="text"],
	#namePasswordForm input[type="password"]{
		font-size: 18px;
		margin-top: 20px;
	}
	#rankingBoard {
		max-width: 80%;
		max-height: 80%;
		overflow-y: auto;
	}
	#retryButton {
		display: none;
		position: fixed;
		top: 50px;
		left: 20%;
		transform: translateX(-50%);
		padding: 20px 40px;
		background-color: #007bff;
		color: white;
		border: none;
		border-radius: 8px;
		cursor: pointer;
		text-align: center;
		font-size: 20px;
	}
	#retryButton:hover {
		background-color: #0056b3;
	}
</style>
</head>
<body>
<div id="container"></div>
<div id="scoreDisplay" style="display: none;">スコア: 0</div>
<div id="overlay">
	<div><button id="retryButton" onclick="retry()">リトライ</button></div>
	<div id="namePasswordForm">
		<p>スコアボードに送信</p>
		<div><input type="text" id="nameInput" placeholder="名前"></div>
		<input type="password" id="passwordInput" placeholder="パスワード(任意)">
		<button onclick="submitScore()">送信</button>
	</div>
	<div id="rankingBoard" style="display: none;">
		<h2>ランキングボード</h2>
		<div id="rankingContainer"></div>
	</div>
</div>
</body>
</html>
